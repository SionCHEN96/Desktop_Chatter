<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .audio-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>🔧 音频调试工具</h2>
        
        <div>
            <label>音频URL:</label>
            <input type="text" id="audioUrl" placeholder="输入音频URL或留空使用最新生成的音频">
            <button onclick="loadAudioInfo()">加载音频信息</button>
            <button onclick="testPlayback()">测试播放</button>
            <button onclick="downloadAudio()">下载音频</button>
        </div>
        
        <div class="audio-info" id="audioInfo" style="display: none;">
            <h4>音频信息:</h4>
            <div id="audioDetails"></div>
        </div>
        
        <audio id="debugAudio" controls style="width: 100%; margin: 10px 0;"></audio>
        
        <div>
            <button onclick="checkTTSServer()">检查TTS服务器</button>
            <button onclick="listAudioFiles()">列出音频文件</button>
            <button onclick="testCORS()">测试CORS</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <div class="container">
        <h3>调试日志</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let currentAudio = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkTTSServer() {
            try {
                log('检查TTS服务器状态...');
                const response = await fetch('http://localhost:3002/api/health');
                
                if (response.ok) {
                    const data = await response.json();
                    log('TTS服务器正常: ' + JSON.stringify(data), 'success');
                } else {
                    log(`TTS服务器错误: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`TTS服务器连接失败: ${error.message}`, 'error');
            }
        }

        async function listAudioFiles() {
            try {
                log('获取音频文件列表...');
                const response = await fetch('http://localhost:3002/api/audio/list');

                if (response.ok) {
                    const data = await response.json();

                    if (data.success && data.files.length > 0) {
                        log(`找到 ${data.files.length} 个音频文件:`, 'success');
                        data.files.forEach((file, index) => {
                            const size = (file.size / 1024).toFixed(2);
                            const time = new Date(file.modified).toLocaleTimeString();
                            log(`  ${index + 1}. ${file.filename} (${size}KB, ${time})`);
                        });

                        // 自动设置最新的文件
                        const latestFile = data.files[0];
                        const fullUrl = `http://localhost:3002${latestFile.url}`;
                        document.getElementById('audioUrl').value = fullUrl;
                        log(`已设置最新音频: ${latestFile.filename}`, 'success');
                    } else {
                        log('没有找到音频文件', 'error');
                    }
                } else {
                    log(`无法访问音频API: ${response.status}`, 'error');

                    // 尝试旧方法
                    log('尝试直接访问音频目录...');
                    const dirResponse = await fetch('http://localhost:3002/generated_audio/');
                    if (dirResponse.ok) {
                        log('音频目录可访问', 'success');
                    } else {
                        log(`音频目录不可访问: ${dirResponse.status}`, 'error');
                    }
                }
            } catch (error) {
                log(`获取音频文件列表失败: ${error.message}`, 'error');
            }
        }

        async function loadAudioInfo() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                await listAudioFiles();
                return;
            }

            try {
                log(`加载音频信息: ${url}`);
                
                const response = await fetch(url, { method: 'HEAD' });
                log(`响应状态: ${response.status} ${response.statusText}`);
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                log('响应头: ' + JSON.stringify(headers, null, 2));
                
                if (response.ok) {
                    const audioInfo = document.getElementById('audioInfo');
                    const audioDetails = document.getElementById('audioDetails');
                    
                    audioDetails.innerHTML = `
                        <p><strong>URL:</strong> ${url}</p>
                        <p><strong>状态:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>内容类型:</strong> ${headers['content-type'] || '未知'}</p>
                        <p><strong>内容长度:</strong> ${headers['content-length'] || '未知'} 字节</p>
                        <p><strong>最后修改:</strong> ${headers['last-modified'] || '未知'}</p>
                    `;
                    
                    audioInfo.style.display = 'block';
                    log('音频信息加载成功', 'success');
                } else {
                    log(`音频文件不可访问: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`加载音频信息失败: ${error.message}`, 'error');
            }
        }

        async function testPlayback() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                log('请先输入音频URL', 'error');
                return;
            }

            try {
                log(`测试播放: ${url}`);
                
                // 停止当前播放
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                // 设置到页面的audio元素
                const audioElement = document.getElementById('debugAudio');
                audioElement.src = url;
                
                // 创建新的Audio对象
                const audio = new Audio(url);
                currentAudio = audio;
                
                // 添加事件监听器
                audio.addEventListener('loadstart', () => log('开始加载音频'));
                audio.addEventListener('loadedmetadata', () => {
                    log(`音频元数据加载完成 - 时长: ${audio.duration.toFixed(2)}秒`);
                });
                audio.addEventListener('loadeddata', () => log('音频数据加载完成'));
                audio.addEventListener('canplay', () => log('音频可以开始播放'));
                audio.addEventListener('canplaythrough', () => log('音频可以完整播放'));
                audio.addEventListener('play', () => log('音频开始播放', 'success'));
                audio.addEventListener('playing', () => log('音频正在播放'));
                audio.addEventListener('pause', () => log('音频暂停'));
                audio.addEventListener('ended', () => log('音频播放结束', 'success'));
                audio.addEventListener('error', (e) => {
                    const error = audio.error;
                    let errorMsg = '未知错误';
                    if (error) {
                        switch (error.code) {
                            case 1: errorMsg = 'MEDIA_ERR_ABORTED - 播放被中止'; break;
                            case 2: errorMsg = 'MEDIA_ERR_NETWORK - 网络错误'; break;
                            case 3: errorMsg = 'MEDIA_ERR_DECODE - 解码错误'; break;
                            case 4: errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED - 格式不支持'; break;
                        }
                    }
                    log(`音频播放错误: ${errorMsg}`, 'error');
                });
                
                // 尝试播放
                const playPromise = audio.play();
                if (playPromise) {
                    await playPromise;
                    log('播放成功启动', 'success');
                }
                
            } catch (error) {
                log(`播放测试失败: ${error.message}`, 'error');
            }
        }

        async function downloadAudio() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                log('请先输入音频URL', 'error');
                return;
            }

            try {
                log(`下载音频: ${url}`);
                const a = document.createElement('a');
                a.href = url;
                a.download = url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                log('下载开始', 'success');
            } catch (error) {
                log(`下载失败: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            const url = document.getElementById('audioUrl').value.trim() || 'http://localhost:3002/api/health';
            
            try {
                log(`测试CORS: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`CORS测试结果: ${response.status} ${response.statusText}`, 'success');
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                log('CORS相关头部: ' + JSON.stringify({
                    'access-control-allow-origin': headers['access-control-allow-origin'],
                    'access-control-allow-methods': headers['access-control-allow-methods'],
                    'access-control-allow-headers': headers['access-control-allow-headers']
                }, null, 2));
                
            } catch (error) {
                log(`CORS测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('音频调试工具已加载');
            checkTTSServer();
            listAudioFiles();
        });
    </script>
</body>
</html>
