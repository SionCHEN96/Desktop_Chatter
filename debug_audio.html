<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .audio-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ”§ éŸ³é¢‘è°ƒè¯•å·¥å…·</h2>
        
        <div>
            <label>éŸ³é¢‘URL:</label>
            <input type="text" id="audioUrl" placeholder="è¾“å…¥éŸ³é¢‘URLæˆ–ç•™ç©ºä½¿ç”¨æœ€æ–°ç”Ÿæˆçš„éŸ³é¢‘">
            <button onclick="loadAudioInfo()">åŠ è½½éŸ³é¢‘ä¿¡æ¯</button>
            <button onclick="testPlayback()">æµ‹è¯•æ’­æ”¾</button>
            <button onclick="downloadAudio()">ä¸‹è½½éŸ³é¢‘</button>
        </div>
        
        <div class="audio-info" id="audioInfo" style="display: none;">
            <h4>éŸ³é¢‘ä¿¡æ¯:</h4>
            <div id="audioDetails"></div>
        </div>
        
        <audio id="debugAudio" controls style="width: 100%; margin: 10px 0;"></audio>
        
        <div>
            <button onclick="checkTTSServer()">æ£€æŸ¥TTSæœåŠ¡å™¨</button>
            <button onclick="listAudioFiles()">åˆ—å‡ºéŸ³é¢‘æ–‡ä»¶</button>
            <button onclick="testCORS()">æµ‹è¯•CORS</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <div class="container">
        <h3>è°ƒè¯•æ—¥å¿—</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let currentAudio = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkTTSServer() {
            try {
                log('æ£€æŸ¥TTSæœåŠ¡å™¨çŠ¶æ€...');
                const response = await fetch('http://localhost:3002/api/health');
                
                if (response.ok) {
                    const data = await response.json();
                    log('TTSæœåŠ¡å™¨æ­£å¸¸: ' + JSON.stringify(data), 'success');
                } else {
                    log(`TTSæœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`TTSæœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function listAudioFiles() {
            try {
                log('è·å–éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨...');
                const response = await fetch('http://localhost:3002/api/audio/list');

                if (response.ok) {
                    const data = await response.json();

                    if (data.success && data.files.length > 0) {
                        log(`æ‰¾åˆ° ${data.files.length} ä¸ªéŸ³é¢‘æ–‡ä»¶:`, 'success');
                        data.files.forEach((file, index) => {
                            const size = (file.size / 1024).toFixed(2);
                            const time = new Date(file.modified).toLocaleTimeString();
                            log(`  ${index + 1}. ${file.filename} (${size}KB, ${time})`);
                        });

                        // è‡ªåŠ¨è®¾ç½®æœ€æ–°çš„æ–‡ä»¶
                        const latestFile = data.files[0];
                        const fullUrl = `http://localhost:3002${latestFile.url}`;
                        document.getElementById('audioUrl').value = fullUrl;
                        log(`å·²è®¾ç½®æœ€æ–°éŸ³é¢‘: ${latestFile.filename}`, 'success');
                    } else {
                        log('æ²¡æœ‰æ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶', 'error');
                    }
                } else {
                    log(`æ— æ³•è®¿é—®éŸ³é¢‘API: ${response.status}`, 'error');

                    // å°è¯•æ—§æ–¹æ³•
                    log('å°è¯•ç›´æ¥è®¿é—®éŸ³é¢‘ç›®å½•...');
                    const dirResponse = await fetch('http://localhost:3002/generated_audio/');
                    if (dirResponse.ok) {
                        log('éŸ³é¢‘ç›®å½•å¯è®¿é—®', 'success');
                    } else {
                        log(`éŸ³é¢‘ç›®å½•ä¸å¯è®¿é—®: ${dirResponse.status}`, 'error');
                    }
                }
            } catch (error) {
                log(`è·å–éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadAudioInfo() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                await listAudioFiles();
                return;
            }

            try {
                log(`åŠ è½½éŸ³é¢‘ä¿¡æ¯: ${url}`);
                
                const response = await fetch(url, { method: 'HEAD' });
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                log('å“åº”å¤´: ' + JSON.stringify(headers, null, 2));
                
                if (response.ok) {
                    const audioInfo = document.getElementById('audioInfo');
                    const audioDetails = document.getElementById('audioDetails');
                    
                    audioDetails.innerHTML = `
                        <p><strong>URL:</strong> ${url}</p>
                        <p><strong>çŠ¶æ€:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>å†…å®¹ç±»å‹:</strong> ${headers['content-type'] || 'æœªçŸ¥'}</p>
                        <p><strong>å†…å®¹é•¿åº¦:</strong> ${headers['content-length'] || 'æœªçŸ¥'} å­—èŠ‚</p>
                        <p><strong>æœ€åä¿®æ”¹:</strong> ${headers['last-modified'] || 'æœªçŸ¥'}</p>
                    `;
                    
                    audioInfo.style.display = 'block';
                    log('éŸ³é¢‘ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
                } else {
                    log(`éŸ³é¢‘æ–‡ä»¶ä¸å¯è®¿é—®: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`åŠ è½½éŸ³é¢‘ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPlayback() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                log('è¯·å…ˆè¾“å…¥éŸ³é¢‘URL', 'error');
                return;
            }

            try {
                log(`æµ‹è¯•æ’­æ”¾: ${url}`);
                
                // åœæ­¢å½“å‰æ’­æ”¾
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                // è®¾ç½®åˆ°é¡µé¢çš„audioå…ƒç´ 
                const audioElement = document.getElementById('debugAudio');
                audioElement.src = url;
                
                // åˆ›å»ºæ–°çš„Audioå¯¹è±¡
                const audio = new Audio(url);
                currentAudio = audio;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                audio.addEventListener('loadstart', () => log('å¼€å§‹åŠ è½½éŸ³é¢‘'));
                audio.addEventListener('loadedmetadata', () => {
                    log(`éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ - æ—¶é•¿: ${audio.duration.toFixed(2)}ç§’`);
                });
                audio.addEventListener('loadeddata', () => log('éŸ³é¢‘æ•°æ®åŠ è½½å®Œæˆ'));
                audio.addEventListener('canplay', () => log('éŸ³é¢‘å¯ä»¥å¼€å§‹æ’­æ”¾'));
                audio.addEventListener('canplaythrough', () => log('éŸ³é¢‘å¯ä»¥å®Œæ•´æ’­æ”¾'));
                audio.addEventListener('play', () => log('éŸ³é¢‘å¼€å§‹æ’­æ”¾', 'success'));
                audio.addEventListener('playing', () => log('éŸ³é¢‘æ­£åœ¨æ’­æ”¾'));
                audio.addEventListener('pause', () => log('éŸ³é¢‘æš‚åœ'));
                audio.addEventListener('ended', () => log('éŸ³é¢‘æ’­æ”¾ç»“æŸ', 'success'));
                audio.addEventListener('error', (e) => {
                    const error = audio.error;
                    let errorMsg = 'æœªçŸ¥é”™è¯¯';
                    if (error) {
                        switch (error.code) {
                            case 1: errorMsg = 'MEDIA_ERR_ABORTED - æ’­æ”¾è¢«ä¸­æ­¢'; break;
                            case 2: errorMsg = 'MEDIA_ERR_NETWORK - ç½‘ç»œé”™è¯¯'; break;
                            case 3: errorMsg = 'MEDIA_ERR_DECODE - è§£ç é”™è¯¯'; break;
                            case 4: errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED - æ ¼å¼ä¸æ”¯æŒ'; break;
                        }
                    }
                    log(`éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${errorMsg}`, 'error');
                });
                
                // å°è¯•æ’­æ”¾
                const playPromise = audio.play();
                if (playPromise) {
                    await playPromise;
                    log('æ’­æ”¾æˆåŠŸå¯åŠ¨', 'success');
                }
                
            } catch (error) {
                log(`æ’­æ”¾æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function downloadAudio() {
            const url = document.getElementById('audioUrl').value.trim();
            if (!url) {
                log('è¯·å…ˆè¾“å…¥éŸ³é¢‘URL', 'error');
                return;
            }

            try {
                log(`ä¸‹è½½éŸ³é¢‘: ${url}`);
                const a = document.createElement('a');
                a.href = url;
                a.download = url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                log('ä¸‹è½½å¼€å§‹', 'success');
            } catch (error) {
                log(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            const url = document.getElementById('audioUrl').value.trim() || 'http://localhost:3002/api/health';
            
            try {
                log(`æµ‹è¯•CORS: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`CORSæµ‹è¯•ç»“æœ: ${response.status} ${response.statusText}`, 'success');
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                log('CORSç›¸å…³å¤´éƒ¨: ' + JSON.stringify({
                    'access-control-allow-origin': headers['access-control-allow-origin'],
                    'access-control-allow-methods': headers['access-control-allow-methods'],
                    'access-control-allow-headers': headers['access-control-allow-headers']
                }, null, 2));
                
            } catch (error) {
                log(`CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('éŸ³é¢‘è°ƒè¯•å·¥å…·å·²åŠ è½½');
            checkTTSServer();
            listAudioFiles();
        });
    </script>
</body>
</html>
